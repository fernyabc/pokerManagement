<!DOCTYPE html>
<html>
<head>
    <title>pokerManagement - Glasses Broadcaster</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 40px; background: #f5f5f7; color: #333; }
        #container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; }
        video { width: 100%; border-radius: 8px; background: #000; }
        #status { padding: 10px; border-radius: 6px; margin-top: 15px; font-weight: 500; }
        .connecting { background-color: #ffc; border: 1px solid #eea; }
        .connected { background-color: #cfc; border: 1px solid #aea; }
        .disconnected { background-color: #fcc; border: 1px solid #eaa; }
    </style>
</head>
<body>
    <div id="container">
        <h1>Glasses Stream (Broadcaster)</h1>
        <p>This page simulates the video feed from the Ray-Ban Meta glasses. Keep this page open and running to stream video to the iOS app.</p>
        <video id="video" autoplay playsinline></video>
        <div id="status" class="connecting">Status: Connecting to Signaling Server...</div>
    </div>
    <script>
        const statusDiv = document.getElementById('status');
        const video = document.getElementById('video');

        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        let peerConnection;

        const config = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        ws.onopen = () => {
            statusDiv.textContent = 'Status: Connected to Signaling Server. Waiting for iOS app...';
        };

        ws.onmessage = async (event) => {
            const message = JSON.parse(event.data);
            
            if (message.answer) {
                statusDiv.textContent = 'Status: Received answer from iOS. Setting remote description...';
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
            } else if (message.iceCandidate) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(message.iceCandidate));
                } catch (e) {
                    console.error('Error adding received ice candidate', e);
                }
            } else if (message.type === 'start') {
                // The iOS client is ready, let's start the WebRTC handshake
                await startWebRTC();
            }
        };

        async function startWebRTC() {
            statusDiv.textContent = 'Status: iOS client connected. Starting WebRTC handshake...';
            peerConnection = new RTCPeerConnection(config);

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ iceCandidate: event.candidate }));
                }
            };
            
            peerConnection.onconnectionstatechange = event => {
                if (peerConnection.connectionState === 'connected') {
                    statusDiv.textContent = 'Status: Streaming to iOS App.';
                    statusDiv.className = 'connected';
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            video.srcObject = stream;
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            statusDiv.textContent = 'Status: Created offer. Sending to iOS app via signaling server...';
            ws.send(JSON.stringify({ offer: offer }));
        }
    </script>
</body>
</html>
